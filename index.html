<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CryptoX - Demo Trading</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f172a; --panel:#0f1724; --muted:#94a3b8; --text:#e2e8f0; --accent:#10b981;
    }
    .light { --bg:#f8fafc; --panel:#ffffff; --muted:#475569; --text:#0f172a; --accent:#f97316; }
    body{ background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
    .form-input{ background:var(--panel); border:1px solid rgba(100,116,139,.12); color:var(--text); border-radius:.375rem; padding:.5rem .75rem; width:100%; }
    .form-input:focus{ outline:2px solid rgba(37,99,235,.15); outline-offset:2px; }
    .page{ display:none; }
    .page.active{ display:block; }
    /* small scrollbar */
    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-thumb{ background:rgba(100,116,139,.25); border-radius:6px; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-opacity-70 backdrop-blur p-3 border-b">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <svg class="w-8 h-8 text-indigo-500" viewBox="0 0 24 24" fill="none"><path d="M3 16.5L10 9.5l4 4 7-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>
          <div id="brand" class="font-bold text-lg">CryptoX</div>
          <div id="small-tag" class="text-xs text-muted">Demo trading playground</div>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <div id="user-area" class="hidden items-center space-x-4">
          <div class="text-right">
            <div id="welcome" class="text-sm font-medium"></div>
            <div id="balance-display" class="text-xs text-amber-400 font-semibold"></div>
          </div>
          <button id="deposit-btn" class="px-3 py-1 rounded bg-indigo-500 text-white text-sm">Deposit</button>
          <button id="withdraw-btn" class="px-3 py-1 rounded bg-gray-700 text-white text-sm">Withdraw</button>
          <button id="logout-btn" class="px-3 py-1 rounded border text-sm">Logout</button>
        </div>

        <button id="auth-open" class="px-3 py-2 rounded border text-sm">Login / Sign up</button>

        <button id="connect-wallet-btn" class="px-3 py-2 rounded bg-emerald-500 text-white text-sm">Connect Wallet</button>

        <button id="theme-toggle" class="px-3 py-2 rounded border text-sm">Toggle theme</button>
      </div>
    </div>
  </header>

  <!-- Pages -->
  <main class="container mx-auto p-4 flex-grow">
    <!-- AUTH PAGE -->
    <section id="auth-page" class="page">
      <div class="grid grid-cols-12 gap-8">
        <div class="col-span-12 lg:col-span-6">
          <h1 class="text-3xl font-bold">Welcome to <span class="text-indigo-500">CryptoX</span></h1>
          <p class="text-sm text-muted mt-2">Demo trading using CoinGecko prices. Create an account to get $100,000 starting USD, buy/sell simulated crypto, and track your trades.</p>
          <div class="mt-4 space-x-2">
            <button id="show-login" class="px-4 py-2 rounded bg-indigo-600 text-white">Login</button>
            <button id="show-signup" class="px-4 py-2 rounded border">Sign up</button>
          </div>
        </div>

        <div class="col-span-12 lg:col-span-6">
          <!-- Login -->
          <div id="login-box" class="p-6 rounded shadow bg-white/5">
            <h2 class="text-xl font-semibold">Login</h2>
            <form id="login-form" class="mt-4 space-y-3">
              <input id="login-email" class="form-input" type="email" placeholder="Email" required />
              <input id="login-password" class="form-input" type="password" placeholder="Password" required />
              <div class="flex items-center justify-between">
                <button class="px-4 py-2 rounded bg-indigo-600 text-white">Login</button>
                <a id="goto-signup" class="text-sm text-muted cursor-pointer">Create account</a>
              </div>
              <div id="login-msg" class="text-sm text-rose-400"></div>
            </form>
          </div>

          <!-- Signup -->
          <div id="signup-box" class="p-6 rounded shadow bg-white/5 mt-4 hidden">
            <h2 class="text-xl font-semibold">Sign up</h2>
            <form id="signup-form" class="mt-4 space-y-3">
              <input id="signup-username" class="form-input" type="text" placeholder="Username" required />
              <input id="signup-email" class="form-input" type="email" placeholder="Email" required />
              <input id="signup-password" class="form-input" type="password" placeholder="Password" required />
              <input id="signup-confirm" class="form-input" type="password" placeholder="Confirm password" required />
              <div class="flex items-center justify-between">
                <button class="px-4 py-2 rounded bg-emerald-600 text-white">Create account</button>
                <a id="goto-login" class="text-sm text-muted cursor-pointer">Have an account?</a>
              </div>
              <div id="signup-msg" class="text-sm text-emerald-300"></div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard-page" class="page hidden">
      <div class="grid grid-cols-12 gap-4">
        <!-- Markets -->
        <aside class="col-span-12 lg:col-span-3 bg-white/5 rounded p-3">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Markets</h3>
            <input id="market-filter" placeholder="Search" class="form-input text-sm w-32" />
          </div>
          <div class="overflow-auto max-h-[48vh]">
            <table class="w-full text-sm">
              <thead class="text-muted text-xs">
                <tr><th class="text-left">Pair</th><th class="text-right">Price</th><th class="text-right">24h</th></tr>
              </thead>
              <tbody id="market-list"></tbody>
            </table>
          </div>
        </aside>

        <!-- Chart & Order -->
        <div class="col-span-12 lg:col-span-6 flex flex-col gap-4">
          <div class="bg-white/5 rounded p-3">
            <div class="flex items-center justify-between">
              <div>
                <div id="pair-title" class="font-bold text-lg">BTC / USD</div>
                <div id="pair-sub" class="text-sm text-muted">Bitcoin</div>
              </div>
              <div class="text-right">
                <div id="price-display" class="text-2xl font-semibold">$--</div>
                <div id="change-display" class="text-sm text-muted">--</div>
              </div>
            </div>

            <div class="mt-3 h-60">
              <canvas id="chart-canvas" class="w-full h-full"></canvas>
            </div>
          </div>

          <div class="bg-white/5 rounded p-3">
            <div class="flex border-b pb-2 mb-3">
              <button id="buy-btn" class="flex-1 text-left font-semibold text-green-400">Buy</button>
              <button id="sell-btn" class="flex-1 text-left text-muted">Sell</button>
            </div>

            <form id="order-form" class="space-y-3">
              <div class="grid grid-cols-2 gap-2">
                <button type="button" id="market-type" class="px-3 py-2 rounded bg-gray-700 text-white">Market</button>
                <button type="button" id="limit-type" class="px-3 py-2 rounded border text-muted">Limit</button>
              </div>

              <div id="limit-group" class="hidden">
                <label class="text-sm text-muted">Price (USD)</label>
                <input id="order-price" class="form-input" type="number" step="any" />
              </div>

              <div>
                <label class="text-sm text-muted">Amount (<span id="asset-symbol">BTC</span>)</label>
                <input id="order-amount" class="form-input" type="number" step="any" />
              </div>

              <div>
                <label class="text-sm text-muted">Total (USD)</label>
                <input id="order-total" class="form-input" type="number" step="any" />
              </div>

              <div class="flex items-center space-x-2">
                <button id="submit-order" class="px-4 py-2 rounded bg-green-600 text-white">Buy</button>
                <button type="button" id="clear-order" class="px-4 py-2 rounded border">Clear</button>
                <div id="order-msg" class="text-sm text-rose-400 ml-3"></div>
              </div>
            </form>
          </div>
        </div>

        <!-- Orderbook & Trades -->
        <aside class="col-span-12 lg:col-span-3 bg-white/5 rounded p-3 flex flex-col">
          <div class="flex items-center justify-between mb-3">
            <div class="flex space-x-2">
              <button id="ob-tab" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Order Book</button>
              <button id="trades-tab" class="px-3 py-1 border rounded text-sm">Recent Trades</button>
            </div>
            <div id="orderbook-mid" class="text-sm text-muted">$--</div>
          </div>

          <div id="orderbook-view">
            <div class="overflow-auto max-h-[34vh]">
              <table class="text-xs w-full">
                <thead class="text-muted text-xs"><tr><th>Price</th><th class="text-right">Amt</th><th class="text-right">Total</th></tr></thead>
                <tbody id="asks"></tbody>
              </table>
              <div class="py-2"></div>
              <table class="text-xs w-full"><tbody id="bids"></tbody></table>
            </div>
          </div>

          <div id="trades-view" class="hidden">
            <div class="overflow-auto max-h-[46vh]">
              <table class="w-full text-xs">
                <thead class="text-muted text-xs"><tr><th>Price</th><th class="text-right">Amount</th><th class="text-right">Time</th></tr></thead>
                <tbody id="trade-list"></tbody>
              </table>
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="p-4 text-center text-sm text-muted">
    CryptoX demo — CoinGecko data — Not financial advice
  </footer>

  <!-- Modals: deposit/withdraw/wallet -->
  <div id="deposit-modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white/5 p-4 rounded w-80">
      <h3 class="font-semibold">Deposit USD</h3>
      <input id="deposit-amount" class="form-input mt-3" type="number" step="any" placeholder="Amount USD" />
      <div class="flex justify-end mt-3 space-x-2">
        <button id="deposit-confirm" class="px-3 py-1 rounded bg-emerald-600 text-white">Deposit</button>
        <button id="deposit-cancel" class="px-3 py-1 rounded border">Cancel</button>
      </div>
    </div>
  </div>

  <div id="withdraw-modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white/5 p-4 rounded w-80">
      <h3 class="font-semibold">Withdraw USD</h3>
      <input id="withdraw-amount" class="form-input mt-3" type="number" step="any" placeholder="Amount USD" />
      <div class="flex justify-end mt-3 space-x-2">
        <button id="withdraw-confirm" class="px-3 py-1 rounded bg-rose-500 text-white">Withdraw</button>
        <button id="withdraw-cancel" class="px-3 py-1 rounded border">Cancel</button>
      </div>
    </div>
  </div>

  <div id="wallet-modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white/5 p-4 rounded w-96">
      <h3 class="font-semibold">Connect Wallet</h3>
      <div class="mt-3 space-y-2">
        <button id="metamask-btn" class="px-3 py-2 rounded bg-orange-500 text-white w-full">Connect MetaMask</button>
        <button id="walletconnect-btn" class="px-3 py-2 rounded border w-full">WalletConnect (Docs)</button>
      </div>
      <div class="text-sm text-muted mt-3" id="wallet-info"></div>
      <div class="flex justify-end mt-3"><button id="wallet-close" class="px-3 py-1 rounded border">Close</button></div>
    </div>
  </div>

<script>
/* -------------------------
   CryptoX single-file app
   - Users, balances, holdings, trades in localStorage
   - Starting USD: 100,000
   - CoinGecko for prices (BTC, ETH, DOGE)
   - Chart.js 24h
   - Theme toggle
   - Deposit/Withdraw
   - Password hashing (SHA-256 via Web Crypto)
   ------------------------- */

(() => {
  // CONFIG
  const START_USD = 100000;
  const COINS = [
    { pair: 'BTC/USD', id: 'bitcoin', name:'Bitcoin', symbol:'BTC' },
    { pair: 'ETH/USD', id: 'ethereum', name:'Ethereum', symbol:'ETH' },
    { pair: 'DOGE/USD', id: 'dogecoin', name:'Dogecoin', symbol:'DOGE' }
  ];

  // STATE
  let markets = COINS.map(c=>({ ...c, price:0, change:0 }));
  let selected = markets[0];
  let priceChart = null;
  let isBuy = true;
  let isMarket = true;

  // DOM
  const pages = { auth: document.getElementById('auth-page'), dash: document.getElementById('dashboard-page') };
  const loginBox = document.getElementById('login-box'), signupBox = document.getElementById('signup-box');
  const loginForm = document.getElementById('login-form'), signupForm = document.getElementById('signup-form');
  const loginMsg = document.getElementById('login-msg'), signupMsg = document.getElementById('signup-msg');
  const showLogin = document.getElementById('show-login'), showSignup = document.getElementById('show-signup');
  const gotoSignup = document.getElementById('goto-signup'), gotoLogin = document.getElementById('goto-login');
  const authOpen = document.getElementById('auth-open');

  const userArea = document.getElementById('user-area'), welcomeEl = document.getElementById('welcome'), balanceEl = document.getElementById('balance-display');
  const depositBtn = document.getElementById('deposit-btn'), withdrawBtn = document.getElementById('withdraw-btn');
  const depositModal = document.getElementById('deposit-modal'), withdrawModal = document.getElementById('withdraw-modal');
  const depositConfirm = document.getElementById('deposit-confirm'), depositCancel = document.getElementById('deposit-cancel');
  const withdrawConfirm = document.getElementById('withdraw-confirm'), withdrawCancel = document.getElementById('withdraw-cancel');
  const depositAmount = document.getElementById('deposit-amount'), withdrawAmount = document.getElementById('withdraw-amount');

  const marketList = document.getElementById('market-list'), filterInput = document.getElementById('market-filter');
  const pairTitle = document.getElementById('pair-title'), pairSub = document.getElementById('pair-sub');
  const priceDisplay = document.getElementById('price-display'), changeDisplay = document.getElementById('change-display');
  const chartCanvas = document.getElementById('chart-canvas');

  const buyBtn = document.getElementById('buy-btn'), sellBtn = document.getElementById('sell-btn');
  const marketTypeBtn = document.getElementById('market-type'), limitTypeBtn = document.getElementById('limit-type');
  const limitGroup = document.getElementById('limit-group');
  const orderPrice = document.getElementById('order-price'), orderAmount = document.getElementById('order-amount'), orderTotal = document.getElementById('order-total');
  const submitOrder = document.getElementById('submit-order'), clearOrder = document.getElementById('clear-order'), orderMsg = document.getElementById('order-msg');
  const assetSymbol = document.getElementById('asset-symbol');

  const asksEl = document.getElementById('asks'), bidsEl = document.getElementById('bids');
  const tradeList = document.getElementById('trade-list'), obMid = document.getElementById('orderbook-mid');
  const obTab = document.getElementById('ob-tab'), tradesTab = document.getElementById('trades-tab');
  const orderbookView = document.getElementById('orderbook-view'), tradesView = document.getElementById('trades-view');

  const walletModal = document.getElementById('wallet-modal'), metamaskBtn = document.getElementById('metamask-btn'), walletClose = document.getElementById('wallet-close');
  const walletBtn = document.getElementById('connect-wallet-btn'), walletInfo = document.getElementById('wallet-info');

  const themeToggle = document.getElementById('theme-toggle');

  // STORAGE KEYS
  const USERS_KEY = 'cryptox_users_v2';
  const LOGGED_KEY = 'cryptox_loggedin_v2';
  const SELECTED_KEY = 'cryptox_selected_v2';
  const THEME_KEY = 'cryptox_theme_v2';
  const WALLET_KEY = 'cryptox_wallet_v2';

  // UTIL: hash password with SHA-256 (returns hex)
  async function hashHex(str){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  function getUsers(){ try { return JSON.parse(localStorage.getItem(USERS_KEY)) || {}; } catch(e){ return {}; } }
  function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
  function getLogged(){ return localStorage.getItem(LOGGED_KEY); }
  function setLogged(email){ localStorage.setItem(LOGGED_KEY, email); }
  function clearLogged(){ localStorage.removeItem(LOGGED_KEY); }
  function currentUser(){ const e=getLogged(); if(!e) return null; const u=getUsers(); return u[e]||null; }

  function persistUser(u){ if(!u||!u.email) return; const users = getUsers(); users[u.email]=u; saveUsers(users); }

  // THEME
  function applyTheme(){
    const t = localStorage.getItem(THEME_KEY) || 'dark';
    if (t === 'light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light');
  }
  themeToggle.addEventListener('click', ()=>{
    const cur = document.documentElement.classList.contains('light') ? 'light' : 'dark';
    const next = cur === 'light' ? 'dark' : 'light';
    if (next === 'light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light');
    localStorage.setItem(THEME_KEY, next);
  });
  applyTheme();

  // AUTH UI
  function showPage(name){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    if (name === 'auth'){ pages.auth.classList.add('active'); pages.dash.classList.remove('active'); }
    else { pages.dash.classList.add('active'); pages.auth.classList.remove('active'); }
  }

  function updateAuthUI(){
    const u = currentUser();
    if (u){
      userArea.classList.remove('hidden');
      authOpen.classList.add('hidden');
      welcomeEl.textContent = `Hi, ${u.username}`;
      balanceEl.textContent = `$${Number(u.balanceUsd||0).toLocaleString(undefined,{maximumFractionDigits:2})}`;
    } else {
      userArea.classList.add('hidden');
      authOpen.classList.remove('hidden');
      welcomeEl.textContent = '';
      balanceEl.textContent = '';
    }
  }

  // Signup
  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    signupMsg.textContent = '';
    const username = document.getElementById('signup-username').value.trim();
    const email = document.getElementById('signup-email').value.trim().toLowerCase();
    const pwd = document.getElementById('signup-password').value;
    const confirm = document.getElementById('signup-confirm').value;
    if (!username || !email || !pwd) { signupMsg.textContent = 'All fields required'; return; }
    if (pwd !== confirm) { signupMsg.textContent = 'Passwords do not match'; return; }
    const users = getUsers();
    if (users[email]) { signupMsg.textContent = 'Account exists'; return; }
    const hashed = await hashHex(pwd);
    const user = { username, email, pwdHash: hashed, balanceUsd: START_USD, holdings: {}, trades: [] };
    users[email] = user; saveUsers(users);
    setLogged(email); updateAuthUI(); showPage('dash'); initDashboard();
  });

  // Login
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loginMsg.textContent = '';
    const email = document.getElementById('login-email').value.trim().toLowerCase();
    const pwd = document.getElementById('login-password').value;
    const users = getUsers();
    const u = users[email];
    if (!u){ loginMsg.textContent = 'User not found'; return; }
    const h = await hashHex(pwd);
    if (h !== u.pwdHash){ loginMsg.textContent = 'Incorrect password'; return; }
    setLogged(email); updateAuthUI(); showPage('dash'); initDashboard();
  });

  // Quick toggle buttons
  showLogin.addEventListener('click', ()=>{ loginBox.classList.remove('hidden'); signupBox.classList.add('hidden'); });
  showSignup.addEventListener('click', ()=>{ signupBox.classList.remove('hidden'); loginBox.classList.add('hidden'); });
  gotoSignup.addEventListener('click', ()=>{ signupBox.classList.remove('hidden'); loginBox.classList.add('hidden'); });
  gotoLogin.addEventListener('click', ()=>{ loginBox.classList.remove('hidden'); signupBox.classList.add('hidden'); });
  authOpen.addEventListener('click', ()=> showPage('auth'));

  // Logout
  document.getElementById('logout-btn').addEventListener('click', ()=>{
    clearLogged(); updateAuthUI(); showPage('auth');
  });

  // Deposit / Withdraw modals
  depositBtn.addEventListener('click', ()=> depositModal.classList.remove('hidden'));
  withdrawBtn.addEventListener('click', ()=> withdrawModal.classList.remove('hidden'));
  depositCancel.addEventListener('click', ()=> depositModal.classList.add('hidden'));
  withdrawCancel.addEventListener('click', ()=> withdrawModal.classList.add('hidden'));
  depositConfirm.addEventListener('click', ()=>{
    const amt = parseFloat(depositAmount.value || 0);
    if (!amt || amt <= 0) { alert('Enter amount'); return; }
    const u = currentUser(); if (!u){ alert('Login'); return; }
    u.balanceUsd = Number((Number(u.balanceUsd||0) + amt).toFixed(8)); persistUser(u); updateAuthUI(); depositModal.classList.add('hidden'); depositAmount.value=''; refreshTradeHistoryFromUser();
  });
  withdrawConfirm.addEventListener('click', ()=>{
    const amt = parseFloat(withdrawAmount.value || 0);
    if (!amt || amt <= 0) { alert('Enter amount'); return; }
    const u = currentUser(); if (!u){ alert('Login'); return; }
    if (u.balanceUsd < amt){ alert('Insufficient USD balance'); return; }
    u.balanceUsd = Number((Number(u.balanceUsd) - amt).toFixed(8)); persistUser(u); updateAuthUI(); withdrawModal.classList.add('hidden'); withdrawAmount.value=''; refreshTradeHistoryFromUser();
  });

  // MARKET FETCHING
  async function fetchPrices(){
    try {
      const ids = markets.map(m=>m.id).join(',');
      // we need CoinGecko ids, so prepare list
      const cgIds = markets.map(m=>m.id).join(','); // intentionally placeholder
      // Build query from COINS list above
      const idsParam = COINS.map(c=>c.id).join(',');
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${idsParam}&vs_currencies=usd&include_24hr_change=true`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      markets = markets.map(m=>{
        const cgId = COINS.find(c=>c.pair===m.pair).id;
        if (data[cgId] && data[cgId].usd !== undefined){
          return {...m, price: data[cgId].usd, change: data[cgId].usd_24h_change||0};
        }
        return m;
      });
      // Keep selected reference updated
      const found = markets.find(mm => mm.pair === selected.pair);
      if (found) selected = found;
      renderMarketList();
      renderHeader();
    } catch (err){
      console.warn('Price fetch error', err);
    }
  }

  function renderMarketList(){
    const filter = (filterInput.value||'').toLowerCase();
    marketList.innerHTML = '';
    markets.forEach(m => {
      if (filter && !m.pair.toLowerCase().includes(filter) && !m.name.toLowerCase().includes(filter)) return;
      const tr = document.createElement('tr');
      const isPos = (m.change || 0) >= 0;
      tr.className = 'cursor-pointer hover:bg-white/3';
      tr.innerHTML = `<td class="p-2 font-medium">${m.pair}</td><td class="p-2 text-right">${Number(m.price).toFixed(m.symbol==='DOGE'?4:2)}</td><td class="p-2 text-right ${isPos? 'text-green-400':'text-rose-400'}">${(isPos?'+':'')}${Number(m.change||0).toFixed(2)}%</td>`;
      tr.addEventListener('click', ()=> selectMarket(m));
      marketList.appendChild(tr);
    });
  }

  function selectMarket(m){
    selected = m;
    localStorage.setItem(SELECTED_KEY, JSON.stringify(m));
    renderHeader();
    fetchChartFor(m.id);
  }

  function renderHeader(){
    pairTitle.textContent = `${selected.symbol} / USD`;
    pairSub.textContent = selected.name;
    priceDisplay.textContent = `$${Number(selected.price||0).toFixed(selected.symbol==='DOGE'?4:2)}`;
    changeDisplay.textContent = `${(selected.change>=0?'+':'')}${Number(selected.change||0).toFixed(2)}%`;
    obMid.textContent = `$${Number(selected.price||0).toFixed(selected.symbol==='DOGE'?4:2)}`;
    assetSymbol.textContent = selected.symbol;
  }

  // CHART
  async function fetchChartFor(cgId){
    try {
      const url = `https://api.coingecko.com/api/v3/coins/${cgId}/market_chart?vs_currency=usd&days=1&interval=hourly`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('cg chart fail');
      const data = await res.json();
      const points = (data.prices||[]).slice(-48);
      const labels = points.map(p => new Date(p[0]).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
      const values = points.map(p => p[1]);
      renderChart(labels, values);
    } catch (err){ console.warn('chart err', err); }
  }

  function renderChart(labels, data){
    const ctx = chartCanvas.getContext('2d');
    if (priceChart){
      priceChart.data.labels = labels;
      priceChart.data.datasets[0].data = data;
      priceChart.update();
      return;
    }
    priceChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: `${selected.pair} (24h)`, data, borderWidth:1, pointRadius:0, tension:0.25, fill:true }]},
      options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{display:false} } }
    });
  }

  // ORDER BOOK SIM
  function generateBookEntry(isBid){
    const p = (selected.price||1) * (1 + (Math.random()-0.5) * 0.01 * (isBid? -1:1));
    const amt = (Math.random()*5).toFixed(4);
    const total = (p * amt).toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-1 ${isBid? 'text-green-400':'text-rose-400'}">${Number(p).toFixed(selected.symbol==='DOGE'?4:2)}</td><td class="p-1 text-right">${amt}</td><td class="p-1 text-right text-muted">${total}</td>`;
    return tr;
  }

  function updateOrderBook(){
    asksEl.innerHTML = ''; bidsEl.innerHTML = '';
    for (let i=0;i<8;i++) asksEl.appendChild(generateBookEntry(false));
    for (let i=0;i<8;i++) bidsEl.appendChild(generateBookEntry(true));
  }

  // TRADES UI (per-user)
  function refreshTradeHistoryFromUser(){
    const u = currentUser();
    tradeList.innerHTML = '';
    if (!u || !u.trades) return;
    u.trades.slice(0,80).forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="${t.type==='buy'?'text-green-400':'text-rose-400'} p-1">${Number(t.price).toFixed(selected.symbol==='DOGE'?4:2)}</td><td class="p-1 text-right">${t.amount} ${t.symbol}</td><td class="p-1 text-right text-muted">${t.time}</td>`;
      tradeList.appendChild(tr);
    });
  }

  // ORDER HANDLING
  buyBtn.addEventListener('click', ()=> { setBuySell(true); });
  sellBtn.addEventListener('click', ()=> { setBuySell(false); });
  function setBuySell(b){ isBuy = b; if (b){ buyBtn.classList.add('text-green-400'); sellBtn.classList.remove('text-muted'); submitOrder.textContent = `Buy ${selected.symbol}`; } else { sellBtn.classList.add('text-red-400'); buyBtn.classList.remove('text-green-400'); submitOrder.textContent = `Sell ${selected.symbol}`; } }

  marketTypeBtn.addEventListener('click', ()=> setOrderKind(true));
  limitTypeBtn.addEventListener('click', ()=> setOrderKind(false));
  function setOrderKind(m){
    isMarket = m;
    if (m){ marketTypeBtn.classList.add('bg-gray-700','text-white'); limitTypeBtn.classList.remove('bg-gray-700','text-white'); limitGroup.classList.add('hidden'); orderPrice.value = Number(selected.price||0).toFixed(4); }
    else { limitTypeBtn.classList.add('bg-gray-700','text-white'); marketTypeBtn.classList.remove('bg-gray-700','text-white'); limitGroup.classList.remove('hidden'); orderPrice.value = Number(selected.price||0).toFixed(4); }
  }

  orderAmount.addEventListener('input', ()=> {
    const amt = parseFloat(orderAmount.value||0);
    const p = isMarket ? (selected.price||0) : parseFloat(orderPrice.value||selected.price||0);
    orderTotal.value = (!amt||!p)? '': (amt * p).toFixed(6);
  });
  orderTotal.addEventListener('input', ()=> {
    const total = parseFloat(orderTotal.value||0);
    const p = isMarket ? (selected.price||0) : parseFloat(orderPrice.value||selected.price||0);
    orderAmount.value = (!total||!p)? '': (total / p).toFixed(6);
  });

  submitOrder.addEventListener('click', (e)=>{
    e.preventDefault();
    const amt = parseFloat(orderAmount.value||0);
    const p = isMarket ? (selected.price||0) : parseFloat(orderPrice.value||selected.price||0);
    if (!amt || amt <= 0) { orderMsg.textContent = 'Enter amount'; return; }
    if (!p || p <= 0) { orderMsg.textContent = 'Enter price'; return; }
    const total = Number((amt * p).toFixed(8));
    const u = currentUser();
    if (!u){ alert('Please login'); return; }

    if (isBuy){
      if (u.balanceUsd < total){ alert('Insufficient USD'); return; }
      u.balanceUsd = Number((u.balanceUsd - total).toFixed(8));
      u.holdings[selected.symbol] = Number(((u.holdings[selected.symbol]||0) + amt).toFixed(8));
      const t = { type:'buy', symbol: selected.symbol, amount: amt, price: p, total, time: new Date().toLocaleTimeString() };
      u.trades.unshift(t);
      persistUser(u);
      updateAuthUI(); refreshTradeHistoryFromUser(); prependTradeToUI(t);
      orderMsg.textContent = 'Bought ✓';
    } else {
      const held = Number(u.holdings[selected.symbol]||0);
      if (held < amt){ alert('Insufficient holdings'); return; }
      u.holdings[selected.symbol] = Number((held - amt).toFixed(8));
      u.balanceUsd = Number((u.balanceUsd + total).toFixed(8));
      const t = { type:'sell', symbol:selected.symbol, amount: amt, price: p, total, time: new Date().toLocaleTimeString() };
      u.trades.unshift(t);
      persistUser(u);
      updateAuthUI(); refreshTradeHistoryFromUser(); prependTradeToUI(t);
      orderMsg.textContent = 'Sold ✓';
    }

    setTimeout(()=> orderMsg.textContent = '', 1500);
    // clear fields if market type
    if (isMarket) { orderAmount.value=''; orderTotal.value=''; }
  });

  clearOrder.addEventListener('click', ()=> { orderAmount.value=''; orderTotal.value=''; orderPrice.value=''; });

  function prependTradeToUI(t){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="${t.type==='buy'?'text-green-400':'text-rose-400'} p-1">${Number(t.price).toFixed(selected.symbol==='DOGE'?4:2)}</td><td class="p-1 text-right">${t.amount} ${t.symbol}</td><td class="p-1 text-right text-muted">${t.time}</td>`;
    tradeList.prepend(tr);
  }

  // ORDERBOOK/TABS
  obTab.addEventListener('click', ()=> { orderbookView.classList.remove('hidden'); tradesView.classList.add('hidden'); });
  tradesTab.addEventListener('click', ()=> { tradesView.classList.remove('hidden'); orderbookView.classList.add('hidden'); });

  // WALLET (MetaMask basic)
  metamaskBtn.addEventListener('click', async ()=>{
    if (!window.ethereum){ walletInfo.textContent = 'MetaMask not found (install from metamask.io)'; return; }
    try {
      const accs = await window.ethereum.request({ method: 'eth_requestAccounts' });
      const acc = accs[0];
      const balHex = await window.ethereum.request({ method:'eth_getBalance', params:[acc,'latest'] });
      const ethBal = Number(parseInt(balHex,16)) / 1e18;
      walletInfo.innerHTML = `<div><strong>${acc.slice(0,6)}...${acc.slice(-4)}</strong><div class="text-sm text-muted">${ethBal.toFixed(6)} ETH</div></div>`;
      walletBtn.textContent = `${acc.slice(0,6)}...${acc.slice(-4)}`;
      walletModal.classList.add('hidden');
      localStorage.setItem(WALLET_KEY, acc);
    } catch (err){ console.error(err); walletInfo.textContent = 'Connection failed'; }
  });
  walletBtn.addEventListener('click', ()=> walletModal.classList.remove('hidden'));
  walletClose.addEventListener('click', ()=> walletModal.classList.add('hidden'));
  document.getElementById('walletconnect-btn').addEventListener('click', ()=> window.open('https://walletconnect.com/', '_blank'));

  // INIT / STARTUP
  function initDashboard(){
    // restore selected market
    const sel = JSON.parse(localStorage.getItem(SELECTED_KEY));
    if (sel){
      const found = markets.find(m => m.pair === sel.pair);
      if (found) selected = found;
    }
    renderHeader();
    fetchChartFor(selected.id);
    fetchPrices();
    setInterval(fetchPrices, 10000);
    setInterval(updateOrderBook, 3000);
    setInterval(()=>fetchChartFor(selected.id), 60000);
    updateOrderBook();
    renderMarketList();
    refreshTradeHistoryFromUser();
  }

  // refresh trade history of user
  function refreshTradeHistoryFromUser(){
    tradeList.innerHTML = '';
    const u = currentUser();
    if (!u || !u.trades) return;
    u.trades.slice(0,100).forEach(t=> prependTradeToUI(t));
  }

  // On load: check logged, theme, wallet
  (function startup(){
    const users = getUsers();
    // if no user exists, seed nothing (we'll wait for sign up)
    const logged = getLogged();
    if (logged) {
      updateAuthUI();
      showPage('dash');
      initDashboard();
    } else {
      showPage('auth');
    }
    // theme
    const them = localStorage.getItem(THEME_KEY) || 'dark';
    if (them === 'light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light');
    // wallet restore
    const w = localStorage.getItem(WALLET_KEY);
    if (w) walletBtn.textContent = `${w.slice(0,6)}...${w.slice(-4)}`;
  })();

  // Filter input
  filterInput.addEventListener('input', renderMarketList);

})();
</script>

</body>
</html>