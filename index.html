<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Trading Simulator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for appearance */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background similar to the React version */
        }
        .scrollable-content {
            max-height: 280px;
            overflow-y: auto;
            /* Scrollbar styles for aesthetics */
            scrollbar-width: thin;
            scrollbar-color: #4f46e5 #1f2937;
        }
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 10px;
        }
        .btn-green {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-green:hover:not(:disabled) {
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="p-4 sm:p-6 text-white">

    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-indigo-500/50 pb-4 mb-6">
        <h1 class="text-3xl font-extrabold text-indigo-400 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Trading Sim (HTML/JS)
        </h1>
        <div class="mt-2 sm:mt-0 text-xs text-gray-500">
            <p>Status: <span id="auth-status" class="text-yellow-400">Connecting...</span></p>
            <p>User ID: <span id="user-id" class="text-gray-400 font-mono break-all text-ellipsis overflow-hidden">N/A</span></p>
        </div>
    </header>

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/90 flex flex-col items-center justify-center z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin text-indigo-400"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        <p class="mt-3 text-lg text-indigo-400">Loading portfolio and market data...</p>
    </div>

    <!-- Market Tickers Grid -->
    <section class="mb-8">
        <h2 class="text-xl font-bold mb-4 text-gray-300">Live Market Feed</h2>
        <div id="market-tiles" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <!-- Tiles will be dynamically injected here -->
        </div>
    </section>

    <!-- Main Layout: Portfolio & Trading Form -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Portfolio and Summary Panel -->
        <section class="lg:col-span-2 bg-gray-800 p-5 rounded-xl shadow-2xl h-fit">
            <h2 class="text-xl font-bold mb-4 text-indigo-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                My Portfolio
            </h2>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6" id="summary-cards">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Cash Balance</p>
                    <p class="text-2xl font-bold text-green-400" id="cash-balance-display">$0.00</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Total Assets</p>
                    <p class="text-2xl font-bold" id="asset-value-display">$0.00</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">P&L (Total)</p>
                    <p class="text-2xl font-bold text-yellow-400" id="pnl-display">$0.00 (0.00%)</p>
                </div>
            </div>

            <!-- Holdings Table -->
            <h3 class="text-lg font-semibold mb-3 text-gray-300">Current Holdings</h3>
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700/70">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Asset</th>
                            <th class="p-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">Quantity</th>
                            <th class="p-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Avg. Cost</th>
                            <th class="p-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Market Value</th>
                            <th class="p-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">P&amp;L</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-table-body" class="divide-y divide-gray-700 bg-gray-800">
                        <!-- Portfolio rows will be dynamically injected here -->
                        <tr><td colspan="5" class="p-4 text-center text-gray-500 italic" id="no-holdings-message">Loading holdings...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Trading Form Panel -->
        <section class="lg:col-span-1 bg-gray-800 p-5 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4 text-indigo-400 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-arrow-left-right"><path d="M8 3L4 7L8 11"/><path d="M4 7h16"/><path d="M16 21l4-4l-4-4"/><path d="M20 17H4"/></svg>
                Execute Trade
            </h2>

            <!-- Ticker Selector -->
            <div class="mb-4">
                <label for="ticker-select" class="block text-sm font-medium text-gray-300 mb-2">Asset</label>
                <select
                    id="ticker-select"
                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500"
                >
                    <!-- Options will be dynamically injected here -->
                </select>
            </div>

            <!-- Quantity Input -->
            <div class="mb-4">
                <label for="quantity-input" class="block text-sm font-medium text-gray-300 mb-2">Quantity</label>
                <input
                    id="quantity-input"
                    type="number"
                    min="1"
                    step="1"
                    value="1"
                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="e.g., 10"
                />
            </div>

            <!-- Current Price & Cost Summary -->
            <div class="mb-6 p-3 bg-gray-700 rounded-lg">
                <p class="text-sm text-gray-400">Current Price: <span class="font-semibold text-white" id="current-price-display">$0.00</span></p>
                <p class="text-sm text-gray-400">Estimated Cost: <span class="font-semibold text-white" id="estimated-cost-display">$0.00</span></p>
            </div>

            <!-- Trade Buttons -->
            <div class="flex gap-4">
                <button
                    id="buy-button"
                    class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center btn-green"
                >
                    BUY
                </button>
                <button
                    id="sell-button"
                    class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl shadow-md transition duration-200 disabled:opacity-50 flex items-center justify-center btn-green"
                >
                    SELL
                </button>
            </div>

            <!-- Trade Message -->
            <div id="trade-message" class="mt-4 p-3 rounded-lg text-center hidden"></div>

        </section>
    </div>

    <!-- Transaction History -->
    <section class="mt-8 bg-gray-800 p-5 rounded-xl shadow-2xl">
        <h2 class="text-xl font-bold mb-4 text-gray-300 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 lucide lucide-refresh-cw"><path d="M21 12a9 9 0 0 0-9-9-9.75 9.75 0 1 0 8.03 4.25"/><path d="M17 17l4-4-4-4"/></svg>
            Transaction History (Latest 50)
        </h2>
        <div id="transactions-list" class="space-y-1 scrollable-content pr-2">
            <p class="text-center text-gray-500 italic p-4">Loading transactions...</p>
        </div>
    </section>

    <script type="module">
        // --- Firebase Imports (MUST use ES Modules for vanilla JS) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables and Constants ---
        setLogLevel('debug'); // Enable Firestore logging

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let currentUserId = null;
        let isProcessing = false;

        const MOCK_TICKERS = {
            MSFT: { name: 'Microsoft Corp', initialPrice: 420.00, volatility: 0.005 },
            AAPL: { name: 'Apple Inc', initialPrice: 190.00, volatility: 0.007 },
            NVDA: { name: 'NVIDIA Corp', initialPrice: 900.00, volatility: 0.01 },
            BTC: { name: 'Bitcoin', initialPrice: 65000.00, volatility: 0.015 },
            ETH: { name: 'Ethereum', initialPrice: 3500.00, volatility: 0.012 },
        };

        const initialUserData = {
            cashBalance: 100000.00,
            portfolio: {}, // Ticker -> { quantity, averageCost }
            transactions: [],
        };

        let userData = { ...initialUserData };

        let marketPrices = Object.keys(MOCK_TICKERS).reduce((acc, ticker) => {
            acc[ticker] = { price: MOCK_TICKERS[ticker].initialPrice, change: 0 };
            return acc;
        }, {});

        const TRADING_DOC_PATH = (userId) => `/artifacts/${appId}/users/${userId}/trading_data/user_portfolio`;

        let currentTicker = 'MSFT';


        // --- DOM Elements ---
        const $ = (id) => document.getElementById(id);
        const elements = {
            loadingOverlay: $('loading-overlay'),
            userIdDisplay: $('user-id'),
            authStatus: $('auth-status'),
            marketTiles: $('market-tiles'),
            cashBalanceDisplay: $('cash-balance-display'),
            assetValueDisplay: $('asset-value-display'),
            pnlDisplay: $('pnl-display'),
            portfolioTableBody: $('portfolio-table-body'),
            noHoldingsMessage: $('no-holdings-message'),
            transactionsList: $('transactions-list'),
            tickerSelect: $('ticker-select'),
            quantityInput: $('quantity-input'),
            currentPriceDisplay: $('current-price-display'),
            estimatedCostDisplay: $('estimated-cost-display'),
            buyButton: $('buy-button'),
            sellButton: $('sell-button'),
            tradeMessage: $('trade-message'),
        };

        // --- Utility Functions ---

        /** Formats a number as USD currency. */
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(amount);

        /** Renders the trade message. */
        const showTradeMessage = (msg, isSuccess = true) => {
            elements.tradeMessage.textContent = msg;
            elements.tradeMessage.classList.remove('hidden', 'bg-red-800/50', 'text-red-300', 'bg-green-800/50', 'text-green-300');

            if (isSuccess) {
                elements.tradeMessage.classList.add('bg-green-800/50', 'text-green-300');
            } else {
                elements.tradeMessage.classList.add('bg-red-800/50', 'text-red-300');
            }

            // Hide after 5 seconds
            setTimeout(() => {
                elements.tradeMessage.classList.add('hidden');
            }, 5000);
        };

        // --- Market Simulation Logic ---

        /** Updates the market prices with a small random fluctuation. */
        const updateMarket = () => {
            const newPrices = { ...marketPrices };
            Object.keys(MOCK_TICKERS).forEach(ticker => {
                const { price } = marketPrices[ticker];
                const { volatility } = MOCK_TICKERS[ticker];

                // Small random fluctuation
                const fluctuation = (Math.random() * volatility * 2) - volatility;
                let newPrice = price * (1 + fluctuation);

                if (newPrice < 1) newPrice = 1;

                const change = newPrice - price;

                newPrices[ticker] = {
                    price: newPrice,
                    change: change,
                };
            });
            marketPrices = newPrices;
            renderMarketTiles();
            renderTradeFormSummary();
            // Trigger UI update after market prices change (especially portfolio)
            if (currentUserId) renderDashboard();
        };

        /** Renders the market price tiles. */
        const renderMarketTiles = () => {
            elements.marketTiles.innerHTML = ''; // Clear existing tiles

            Object.entries(MOCK_TICKERS).forEach(([ticker, { name }]) => {
                const { price, change } = marketPrices[ticker];
                const isPositive = change >= 0;
                const changeColor = isPositive ? 'text-green-400' : 'text-red-400';
                const changeIcon = isPositive
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up"><polyline points="22 7 13 16 9 12 2 19"/><polyline points="18 7 22 7 22 11"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-down"><polyline points="22 17 13 8 9 12 2 5"/><polyline points="18 17 22 17 22 13"/></svg>';

                const tileClasses = ticker === currentTicker ? 'bg-indigo-700' : 'bg-gray-800 hover:bg-gray-700';

                const tileHTML = `
                    <div
                        class="p-4 rounded-xl shadow-lg transition-all duration-300 cursor-pointer ${tileClasses}"
                        data-ticker="${ticker}"
                    >
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg text-white">${ticker}</h3>
                            <p class="text-sm text-gray-400">${name}</p>
                        </div>
                        <div class="mt-2">
                            <p class="text-2xl font-extrabold text-white">${formatCurrency(price)}</p>
                            <div class="flex items-center text-sm font-medium mt-1 ${changeColor}">
                                ${changeIcon}
                                <span class="ml-1">${change.toFixed(2)} (${((change / price) * 100).toFixed(2)}%)</span>
                            </div>
                        </div>
                    </div>
                `;

                const tileContainer = document.createElement('div');
                tileContainer.innerHTML = tileHTML.trim();
                const tile = tileContainer.firstChild;

                tile.addEventListener('click', () => {
                    currentTicker = ticker;
                    elements.tickerSelect.value = ticker;
                    renderMarketTiles(); // Re-render to highlight selected ticker
                    renderTradeFormSummary();
                });

                elements.marketTiles.appendChild(tile);
            });
        };

        // --- UI Rendering Functions ---

        /** Populates the trading form's select element. */
        const populateTickerSelect = () => {
            elements.tickerSelect.innerHTML = '';
            Object.keys(MOCK_TICKERS).forEach(ticker => {
                const option = document.createElement('option');
                option.value = ticker;
                option.textContent = `${ticker} - ${MOCK_TICKERS[ticker].name}`;
                elements.tickerSelect.appendChild(option);
            });

            // Set the initial value and update the currentTicker variable
            elements.tickerSelect.value = currentTicker;
            elements.tickerSelect.addEventListener('change', (e) => {
                currentTicker = e.target.value;
                renderTradeFormSummary();
                renderMarketTiles(); // Re-render to highlight selection
            });

            elements.quantityInput.addEventListener('input', renderTradeFormSummary);
            renderTradeFormSummary(); // Initial summary render
        };

        /** Renders the current price and estimated cost in the trading form. */
        const renderTradeFormSummary = () => {
            const price = marketPrices[currentTicker]?.price || 0;
            const quantity = parseFloat(elements.quantityInput.value) || 0;
            const estimatedCost = price * quantity;

            elements.currentPriceDisplay.textContent = formatCurrency(price);
            elements.estimatedCostDisplay.textContent = formatCurrency(estimatedCost);
        };

        /** Renders the main portfolio summary and table. */
        const renderDashboard = () => {
            const portfolio = userData.portfolio || {};
            let totalPortfolioValue = 0;
            let totalCostBasis = 0;

            elements.portfolioTableBody.innerHTML = '';
            elements.noHoldingsMessage.style.display = 'none';

            let hasHoldings = false;

            // 1. Render Portfolio Holdings Table
            Object.entries(portfolio).filter(([, holding]) => holding.quantity > 0).forEach(([ticker, holding]) => {
                hasHoldings = true;
                const currentPrice = marketPrices[ticker]?.price || holding.averageCost;
                const currentValue = holding.quantity * currentPrice;
                const costBasis = holding.quantity * holding.averageCost;
                const pnl = currentValue - costBasis;
                const pnlPercent = (pnl / costBasis) * 100;

                totalPortfolioValue += currentValue;
                totalCostBasis += costBasis;

                const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';

                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700 transition-colors duration-150';
                row.innerHTML = `
                    <td class="p-3 text-white font-medium">${ticker}</td>
                    <td class="p-3 text-center">${holding.quantity.toFixed(2)}</td>
                    <td class="p-3 text-right">${formatCurrency(holding.averageCost)}</td>
                    <td class="p-3 text-right font-bold">${formatCurrency(currentValue)}</td>
                    <td class="p-3 text-right">
                        <span class="${pnlColor}">
                            ${formatCurrency(pnl)} (${pnlPercent.toFixed(2)}%)
                        </span>
                    </td>
                `;
                elements.portfolioTableBody.appendChild(row);
            });

            if (!hasHoldings) {
                elements.noHoldingsMessage.style.display = 'table-cell';
                elements.noHoldingsMessage.colSpan = 5;
                elements.noHoldingsMessage.textContent = 'No holdings yet. Make your first trade!';
            }

            // 2. Render Summary Cards
            const initialInvestment = initialUserData.cashBalance;
            const totalAssetValue = userData.cashBalance + totalPortfolioValue;
            const totalPnl = totalAssetValue - initialInvestment;
            const percentagePnl = (totalPnl / initialInvestment) * 100;
            const pnlColorClass = percentagePnl >= 0 ? 'text-green-400' : 'text-red-400';

            elements.cashBalanceDisplay.textContent = formatCurrency(userData.cashBalance);
            elements.assetValueDisplay.textContent = formatCurrency(totalPortfolioValue);

            elements.pnlDisplay.textContent = `${formatCurrency(totalPnl)} (${percentagePnl.toFixed(2)}%)`;
            elements.pnlDisplay.className = `text-2xl font-bold ${pnlColorClass}`;
        };

        /** Renders the transaction history list. */
        const renderTransactions = () => {
            elements.transactionsList.innerHTML = '';

            if (!userData.transactions || userData.transactions.length === 0) {
                elements.transactionsList.innerHTML = '<p class="text-center text-gray-500 italic p-4">No recent transactions.</p>';
                return;
            }

            userData.transactions.slice(0, 50).forEach(tx => {
                const typeColor = tx.type === 'BUY' ? 'text-green-400 bg-green-900/50' : 'text-red-400 bg-red-900/50';
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 border-b border-gray-700/50 text-sm';
                div.innerHTML = `
                    <span class="font-semibold px-2 py-0.5 rounded-full text-xs ${typeColor}">${tx.type}</span>
                    <span class="font-medium text-white">${tx.ticker} x ${tx.quantity}</span>
                    <span class="text-gray-400">${formatCurrency(tx.price)}</span>
                    <span class="text-xs text-gray-500">${new Date(tx.timestamp).toLocaleTimeString()}</span>
                `;
                elements.transactionsList.appendChild(div);
            });
        };

        // --- Trading Execution Logic (The "Not Demo" Part) ---

        /**
         * Executes a trade and updates Firestore.
         * @param {boolean} isBuy - True for BUY, False for SELL.
         */
        const executeTrade = async (isBuy) => {
            if (!db || !currentUserId || isProcessing) return;

            const quantity = parseFloat(elements.quantityInput.value);
            const currentPrice = marketPrices[currentTicker]?.price;

            if (!currentPrice || quantity <= 0 || isNaN(quantity)) {
                showTradeMessage('Invalid quantity or asset.', false);
                return;
            }

            const cost = quantity * currentPrice;
            const holding = userData.portfolio[currentTicker] || { quantity: 0, averageCost: 0 };
            const tradeType = isBuy ? 'BUY' : 'SELL';

            // Validation
            if (isBuy && cost > userData.cashBalance) {
                showTradeMessage('Insufficient cash for this purchase.', false);
                return;
            }
            if (!isBuy && quantity > holding.quantity) {
                showTradeMessage(`You only hold ${holding.quantity.toFixed(2)} shares of ${currentTicker}.`, false);
                return;
            }

            isProcessing = true;
            elements.buyButton.disabled = true;
            elements.sellButton.disabled = true;
            elements.buyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2 lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> BUY`;
            elements.sellButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin mr-2 lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> SELL`;


            try {
                let newPortfolio = { ...userData.portfolio };
                let newCashBalance = userData.cashBalance;

                if (isBuy) {
                    // Calculate new average cost
                    const totalCost = (holding.quantity * holding.averageCost) + cost;
                    const totalQuantity = holding.quantity + quantity;

                    newPortfolio[currentTicker] = {
                        quantity: totalQuantity,
                        averageCost: totalCost / totalQuantity,
                    };
                    newCashBalance -= cost;
                } else {
                    // Sell logic
                    const newQuantity = holding.quantity - quantity;

                    if (newQuantity <= 0.0001) { // Floating point check
                        delete newPortfolio[currentTicker];
                    } else {
                        newPortfolio[currentTicker] = {
                            ...holding,
                            quantity: newQuantity,
                        };
                    }
                    newCashBalance += cost;
                }

                // Create Transaction Record
                const newTransaction = {
                    type: tradeType,
                    ticker: currentTicker,
                    quantity: quantity,
                    price: currentPrice,
                    timestamp: new Date().toISOString(),
                };

                // Keep transactions list clean and only the latest
                const newTransactions = [newTransaction, ...(userData.transactions || [])].slice(0, 50);

                // Update Firestore
                const docRef = doc(db, TRADING_DOC_PATH(currentUserId));
                await setDoc(docRef, {
                    cashBalance: newCashBalance,
                    portfolio: newPortfolio,
                    transactions: newTransactions,
                }, { merge: true });

                showTradeMessage(`${tradeType} ${quantity} of ${currentTicker} successful at ${formatCurrency(currentPrice)}!`, true);

            } catch (e) {
                console.error("Trade execution error:", e);
                showTradeMessage('An error occurred during trade execution.', false);
            } finally {
                isProcessing = false;
                elements.buyButton.disabled = false;
                elements.sellButton.disabled = false;
                elements.buyButton.innerHTML = 'BUY';
                elements.sellButton.innerHTML = 'SELL';
            }
        };

        // --- Firebase Setup and Real-time Listener ---

        const startFirebaseListeners = (userId) => {
            const docRef = doc(db, TRADING_DOC_PATH(userId));

            // 1. Check if document exists and initialize if not
            const initializeUserDocument = async () => {
                try {
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        await setDoc(docRef, initialUserData);
                        console.log("Initialized new user portfolio.");
                    }
                } catch (e) {
                    console.error("Error initializing user document:", e);
                }
            };
            initializeUserDocument();


            // 2. Setup real-time listener (onSnapshot)
            onSnapshot(docRef, (docSnap) => {
                elements.loadingOverlay.classList.add('hidden'); // Hide loader on first data load

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userData = {
                        ...initialUserData,
                        ...data,
                        portfolio: data.portfolio || {},
                        transactions: data.transactions || [],
                    };
                    console.log("Portfolio updated from Firestore.");
                    // Re-render all UI components with new data
                    renderDashboard();
                    renderTransactions();
                } else {
                    userData = initialUserData;
                    renderDashboard();
                    renderTransactions();
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                elements.authStatus.textContent = "Data Error";
                showTradeMessage('Error fetching data: check console.', false);
            });
        };

        const initFirebase = () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                elements.authStatus.textContent = "Config Error";
                return;
            }

            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);

            const authenticate = async (auth) => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase auth error:", error);
                    // Fallback to anonymous sign-in
                    await signInAnonymously(auth);
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    elements.userIdDisplay.textContent = user.uid;
                    elements.authStatus.textContent = "Connected";
                    elements.authStatus.classList.remove('text-yellow-400');
                    elements.authStatus.classList.add('text-green-400');
                    startFirebaseListeners(user.uid);
                } else {
                    authenticate(auth);
                }
            });
        };

        // --- Main Initialization and Event Listeners ---
        const initApp = () => {
            // Setup initial UI elements
            populateTickerSelect();
            renderMarketTiles();

            // Setup market updates
            setInterval(updateMarket, 3000);

            // Setup button handlers
            elements.buyButton.addEventListener('click', () => executeTrade(true));
            elements.sellButton.addEventListener('click', () => executeTrade(false));

            // Start Firebase connection
            initFirebase();
        };

        window.onload = initApp;

    </script>
</body>
</html>

